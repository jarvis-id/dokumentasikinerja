<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riwayat Laporan - DokKiner</title>
    <style>
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f7f6; color: #333; padding-bottom: 100px; }
        .navbar { display: flex; justify-content: space-around; background: #34495e; padding: 12px 0; position: sticky; top: 0; z-index: 9999; }
        .navbar a { color: white; text-decoration: none; font-weight: bold; font-size: 13px; opacity: 0.7; }
        .navbar a.active { opacity: 1; border-bottom: 2px solid #00d2ff; }
        .container { max-width: 900px; margin: auto; padding: 15px; }
        .filter-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd; }
        .btn-print-full { background: #27ae60; color: white; border: none; padding: 15px; border-radius: 6px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .report-card-wrapper { display: flex; align-items: center; gap: 12px; background: white; margin-bottom: 10px; padding: 12px; border-radius: 8px; border: 1px solid #eee; }
        .report-card-preview { flex-grow: 1; cursor: pointer; position: relative; }
        .btn-del { position: absolute; right: 0; top: 0; background: #e74c3c; color: white; border: none; padding: 5px; border-radius: 4px; font-size: 10px; }

        /* PRINT STYLE */
        #print-area { display: none; }
        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; }
            .navbar, .filter-card, #history-list { display: none !important; }
            #print-area { display: block !important; }
            .page-container { break-after: page; width: 210mm; padding: 10mm; }
            .print-job-item { border: 1px solid #000; margin-bottom: 10px; height: 85mm; display: flex; flex-direction: column; }
            .print-header { background: #34495e !important; color: white !important; padding: 5px; font-weight: bold; font-size: 12px; }
            .print-meta { font-size: 9px; padding: 5px; border-bottom: 1px solid #000; background: #f9f9f9 !important; }
            .print-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; flex-grow: 1; }
            .print-col { border-right: 1px solid #eee; text-align: center; padding: 5px; }
            .print-img-box { height: 45mm; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; }
            .print-img-box img { max-width: 100%; max-height: 100%; }
            .print-desc { padding: 5px; font-size: 10px; }
        }
    </style>
</head>
<body>

<nav class="navbar">
    <a href="index.html">üìù Form Input</a>
    <a href="tampildata.html" class="active">üìÇ Riwayat Laporan</a>
</nav>

<div class="container">
    <div class="filter-card">
        <input type="date" id="f-date" onchange="updateUI()" style="width:100%; padding:10px;">
        <button class="btn-print-full" id="print-btn" onclick="generatePrintView()" disabled>üñ®Ô∏è Cetak Terpilih (0)</button>
    </div>
    <div id="history-list"></div>
</div>

<div id="print-area"><div id="print-content-target"></div></div>

<script>
    function updateUI() {
        const fd = document.getElementById('f-date').value;
        let data = JSON.parse(localStorage.getItem('lapdok_history') || '[]');
        if(fd) data = data.filter(h => h.date === fd);
        
        data.sort((a,b) => new Date(b.date) - new Date(a.date));

        const listDiv = document.getElementById('history-list');
        listDiv.innerHTML = data.map(h => `
            <div class="report-card-wrapper">
                <input type="checkbox" class="report-cb" value="${h.id}" onchange="updateBtn()" style="width:20px; height:20px;">
                <div class="report-card-preview" onclick="restoreToEditor(${h.id})">
                    <button class="btn-del" onclick="deleteItem(event, ${h.id})">Hapus</button>
                    <div style="font-weight:bold; font-size:14px; color:#2c3e50;">üìÖ ${h.timestamp}</div>
                    <div style="font-size:11px; color:#7f8c8d;">üì¶ ${h.data.length} Item | ${h.saveInfo}</div>
                </div>
            </div>`).join('');
        updateBtn();
    }

    function updateBtn() {
        const count = document.querySelectorAll('.report-cb:checked').length;
        document.getElementById('print-btn').disabled = count === 0;
        document.getElementById('print-btn').innerText = `üñ®Ô∏è Cetak Terpilih (${count})`;
    }

    function restoreToEditor(id) {
        if(!confirm("Edit data ini? (Data lama akan ditimpa saat simpan)")) return;
        const history = JSON.parse(localStorage.getItem('lapdok_history') || '[]');
        const entry = history.find(h => h.id === id);
        localStorage.setItem('lapdok_draft', JSON.stringify(entry.data));
        localStorage.setItem('lapdok_edit_context', id);
        window.location.href = "index.html";
    }

    function generatePrintView() {
        const selectedIds = Array.from(document.querySelectorAll('.report-cb:checked')).map(cb => parseFloat(cb.value));
        const allHistory = JSON.parse(localStorage.getItem('lapdok_history') || '[]');
        const dataToPrint = allHistory.filter(h => selectedIds.includes(h.id));

        const target = document.getElementById('print-content-target');
        target.innerHTML = '';

        let items = [];
        dataToPrint.forEach(h => h.data.forEach(d => items.push(d)));

        for (let i = 0; i < items.length; i += 3) {
            const chunk = items.slice(i, i + 3);
            const page = document.createElement('div');
            page.className = 'page-container';
            page.innerHTML = `<h2 style="text-align:center;">DOKUMENTASI PEKERJAAN</h2>` + chunk.map((item, idx) => `
                <div class="print-job-item">
                    <div class="print-header">ITEM #${i + idx + 1}</div>
                    <div class="print-meta">
                        <strong>TANGGAL:</strong> ${new Date(item.workDate).toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric'})} <br>
                        <strong>LOKASI:</strong> ${item.addr}
                    </div>
                    <div class="print-grid">
                        <div class="print-col">SEBELUM<div class="print-img-box">${item.p1 ? `<img src="${item.p1}">`:''}</div></div>
                        <div class="print-col">PROSES<div class="print-img-box">${item.p2 ? `<img src="${item.p2}">`:''}</div></div>
                        <div class="print-col">SESUDAH<div class="print-img-box">${item.p3 ? `<img src="${item.p3}">`:''}</div></div>
                    </div>
                    <div class="print-desc"><strong>KET:</strong> ${item.desc}</div>
                </div>`).join('');
            target.appendChild(page);
        }
        setTimeout(() => window.print(), 500);
    }

    function deleteItem(e, id) { e.stopPropagation(); if(confirm("Hapus?")) { let h = JSON.parse(localStorage.getItem('lapdok_history')); localStorage.setItem('lapdok_history', JSON.stringify(h.filter(x=>x.id!==id))); updateUI(); } }

    window.onload = updateUI;
</script>
</body>
</html>
